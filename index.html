<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å…‰è·¯å®éªŒå®¤ v0.9 (ç»ˆæè§¦æ§ç‰ˆ)</title>
    <style>
        /* å…¨å±€æ ·å¼ - ä¿æŒä¸å˜ */
        body {
            margin: 0; background-color: #0d1117; color: #c9d1d9;
            font-family: 'Consolas', 'Monaco', 'PingFang SC', monospace;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            min-height: 100vh; overflow-x: hidden; touch-action: pan-y;
            padding-top: 10px; box-sizing: border-box;
        }

        /* å“åº”å¼å¸ƒå±€ï¼šHUD */
        #hud-container {
            display: flex; width: 95vw; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; pointer-events: none;
            justify-content: center;
        }
        .hud-box {
            background: rgba(22, 27, 34, 0.85); border: 1px solid #30363d; border-radius: 8px;
            padding: 8px 10px; text-align: center; flex: 1; min-width: 80px;
            backdrop-filter: blur(10px);
        }
        .hud-value { font-size: 18px; font-weight: bold; color: #58a6ff; font-family: 'Consolas', monospace; }
        .hud-label { font-size: 10px; color: #8b949e; display: block; margin-bottom: 2px; }
        .hud-unit { font-size: 12px; color: #8b949e; }
        .highlight-blue { color: #58a6ff; } .highlight-text { color: #f2cc60; }

        /* æ§åˆ¶å° */
        #control-panel {
            width: 90vw; background: rgba(22, 27, 34, 0.95); border: 1px solid #58a6ff;
            border-radius: 8px; padding: 12px; margin-bottom: 15px; box-sizing: border-box;
        }
        .control-group { margin-bottom: 10px; }
        .control-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
        .input-smart { width: 50px; background: #0d1117; border: 1px solid #30363d; color: #58a6ff; text-align: right; border-radius: 4px; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #58a6ff; margin-top: -7px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #30363d; border-radius: 2px; }
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .btn-preset { background: #21262d; border: 1px solid #30363d; color: #c9d1d9; padding: 8px; border-radius: 6px; font-size: 11px; }

        /* ç”»å¸ƒ */
        #canvas-wrapper {
            position: relative; width: 95vw; max-width: 800px; aspect-ratio: 2/1;
            border: 1px solid #30363d; border-radius: 12px; overflow: hidden;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px; background-color: #0d1117;
            touch-action: none; /* ç¦æ­¢ç”»å¸ƒå†…æ»šåŠ¨ */
        }
        canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }

        /* å…¬å¼ */
        #formula-bar { margin-top: 10px; padding: 8px 15px; border-radius: 12px; background: #161b22; border: 1px solid #30363d; font-family: 'Consolas', monospace; color: #c9d1d9; font-size: 14px; }
        .formula-highlight { color: #58a6ff; font-weight: bold; } .formula-result { color: #f2cc60; font-weight: bold; }

        /* å¤§å±é€‚é… */
        @media (min-width: 850px) {
            body { justify-content: center; padding-top: 0; }
            #hud-container { position: absolute; top: 20px; left: 20px; width: auto; flex-direction: row; }
            #control-panel { position: absolute; top: 20px; right: 20px; width: 240px; }
        }
    </style>
</head>
<body>

    <div id="hud-container">
        <div class="hud-box"><span class="hud-label">ç„¦è· F</span><span id="hud-f" class="hud-value">10.0</span><span class="hud-unit">cm</span></div>
        <div class="hud-box"><span class="hud-label">ç‰©è· U</span><span id="val-u" class="hud-value highlight-blue">20.0</span><span class="hud-unit">cm</span></div>
        <div class="hud-box"><span class="hud-label">åƒè· V</span><span id="val-v" class="hud-value highlight-text">20.0</span><span class="hud-unit">cm</span></div>
        <div class="hud-box" style="flex:1.5"><span class="hud-label">æ€§è´¨ Prop</span><span id="img-prop-cn" class="hud-value" style="font-size:14px">åˆ†æä¸­...</span></div>
    </div>

    <div id="control-panel">
        <div class="control-group">
            <div class="control-header"><span>ç„¦è· f</span><input type="text" id="input-f" class="input-smart" value="10.0"></div>
            <input type="range" id="slider-f" min="5" max="20" step="0.1" value="10">
        </div>
        <div class="control-group">
            <div class="control-header"><span>ç‰©è· u</span><input type="text" id="input-u" class="input-smart" value="20.0"></div>
            <input type="range" id="slider-u" min="2" max="50" step="0.1" value="20">
        </div>
        <div class="preset-grid">
            <button class="btn-preset" onclick="setPreset('camera')">ç…§ç›¸æœº</button>
            <button class="btn-preset" onclick="setPreset('projector')">æŠ•å½±ä»ª</button>
            <button class="btn-preset" onclick="setPreset('magnifier')">æ”¾å¤§é•œ</button>
        </div>
    </div>

    <div id="canvas-wrapper">
        <canvas id="opticsCanvas"></canvas>
    </div>

    <div id="formula-bar">
        1/f = 1/u + 1/v &nbsp;|&nbsp; <span id="formula-dynamic">Loading...</span>
    </div>

<script>
    const canvas = document.getElementById('opticsCanvas');
    const ctx = canvas.getContext('2d');
    
    // --- æ ¸å¿ƒï¼šå“åº”å¼ç”»å¸ƒ ---
    function resizeCanvas() {
        const container = document.getElementById('canvas-wrapper');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        draw();
    }
    window.addEventListener('resize', resizeCanvas);

    // --- ç‰©ç†å‚æ•° ---
    const SCALE = 10; // 10px = 1cm
    let f_cm = 10.0; 
    let f = f_cm * SCALE;
    let objectPos = { x_cm: 20.0, h: 60 };
    let isDragging = false;

    // --- äº¤äº’åæ ‡è®¡ç®— (Pointer Event) ---
    function getPointerCm(e) {
        const rect = canvas.getBoundingClientRect();
        // å…¼å®¹é¼ æ ‡å’Œè§¦æ‘¸ (è·å–ç¬¬ä¸€ä¸ªè§¦ç‚¹)
        const clientX = (e.touches && e.touches.length > 0) ? e.touches[0].clientX : e.clientX;
        
        // æ˜ å°„åˆ° Canvas å†…éƒ¨åƒç´ 
        const x_px = (clientX - rect.left) * (canvas.width / rect.width);
        
        // è½¬æ¢ä¸ºç›¸å¯¹äºé€é•œä¸­å¿ƒçš„ cm (å‘å·¦ä¸ºæ­£)
        const lensX = canvas.width / 2;
        return (lensX - x_px) / SCALE;
    }

    // --- äº¤äº’äº‹ä»¶å¤„ç† ---
    function handleStart(e) {
        const u_click = getPointerCm(e);
        
        // ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šåˆ¤å®šèŒƒå›´æ‰©å¤§åˆ° 4cm (ä¹Ÿå°±æ˜¯å·¦å³å„ 40px å®½åº¦çš„åŒºåŸŸ)
        // ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šä¸å†åˆ¤æ–­ Y è½´é«˜åº¦ï¼Œåªè¦åœ¨è¿™ä¸€ç«–æ¡ä¸Šç‚¹å‡»éƒ½ç®—ä¸­
        if (Math.abs(u_click - objectPos.x_cm) < 4.0) {
            isDragging = true;
            canvas.style.cursor = 'grabbing'; // æ”¹å˜å…‰æ ‡å½¢çŠ¶
        }
    }

    function handleMove(e) {
        if (isDragging) {
            if (e.cancelable) e.preventDefault(); // é˜²æ­¢æ‰‹æœºé¡µé¢æ»šåŠ¨
            
            let newU = getPointerCm(e);
            
            // é™åˆ¶èŒƒå›´ (é˜²æ­¢æ‹–å‡ºå±å¹•)
            const maxU = (canvas.width / 2) / SCALE - 0.5;
            if (newU < 1.0) newU = 1.0;
            if (newU > maxU) newU = maxU;
            
            objectPos.x_cm = newU;
            
            // å®æ—¶æ›´æ–°UI
            sliderU.value = newU.toFixed(1);
            inputU.value = newU.toFixed(1);
            updateAllUI();
            draw();
        }
    }

    function handleEnd(e) {
        isDragging = false;
        canvas.style.cursor = 'crosshair';
    }

    // ç»‘å®šæ‰€æœ‰äº‹ä»¶ (Mouse + Touch)
    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    
    // passive: false æ˜¯ä¸ºäº†èƒ½ç”¨ preventDefault é˜»æ­¢æ»šåŠ¨
    canvas.addEventListener('touchstart', handleStart, { passive: false });
    canvas.addEventListener('touchmove', handleMove, { passive: false });
    canvas.addEventListener('touchend', handleEnd);

    // --- UI è”åŠ¨é€»è¾‘ ---
    const sliderF = document.getElementById('slider-f'); const inputF = document.getElementById('input-f');
    const sliderU = document.getElementById('slider-u'); const inputU = document.getElementById('input-u');

    function updateFromInput(type) {
        if (type==='f') { let v=parseFloat(inputF.value); if(!isNaN(v)){f_cm=v; f=f_cm*SCALE; sliderF.value=v;} }
        else { let v=parseFloat(inputU.value); if(!isNaN(v)){objectPos.x_cm=v; sliderU.value=v;} }
        updateAllUI(); draw();
    }
    function updateFromSlider(type) {
        if (type==='f') { f_cm=parseFloat(sliderF.value); f=f_cm*SCALE; inputF.value=f_cm.toFixed(1); }
        else { objectPos.x_cm=parseFloat(sliderU.value); inputU.value=objectPos.x_cm.toFixed(1); }
        updateAllUI(); draw();
    }

    inputF.addEventListener('input', ()=>updateFromInput('f')); inputU.addEventListener('input', ()=>updateFromInput('u'));
    sliderF.addEventListener('input', ()=>updateFromSlider('f')); sliderU.addEventListener('input', ()=>updateFromSlider('u'));

    function setPreset(type) {
        if(type==='camera'){f_cm=10; objectPos.x_cm=30;}
        else if(type==='projector'){f_cm=10; objectPos.x_cm=15;}
        else{f_cm=10; objectPos.x_cm=5;}
        f=f_cm*SCALE; sliderF.value=f_cm; inputF.value=f_cm.toFixed(1);
        sliderU.value=objectPos.x_cm; inputU.value=objectPos.x_cm.toFixed(1);
        updateAllUI(); draw();
    }

    function updateAllUI() {
        document.getElementById('hud-f').innerText = f_cm.toFixed(1);
        document.getElementById('val-u').innerText = objectPos.x_cm.toFixed(1);
        
        let v_disp = "âˆ";
        const u = objectPos.x_cm;
        if (Math.abs(u - f_cm) > 0.1) {
            const v = (f_cm * u) / (u - f_cm);
            v_disp = Math.abs(v).toFixed(1);
        }
        document.getElementById('val-v').innerText = v_disp;
        document.getElementById('formula-dynamic').innerHTML = 
            `1/<span class="formula-highlight">${f_cm.toFixed(1)}</span> = 1/<span class="formula-highlight">${u.toFixed(1)}</span> + 1/<span class="formula-result">${v_disp}</span>`;
    }

    // --- ç»˜å›¾å¼•æ“ ---
    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const lx = canvas.width/2; const ly = canvas.height/2;
        // åŠ¨æ€é«˜åº¦é€‚é…
        const h = objectPos.h * (canvas.height/400);

        // è½´çº¿ä¸åˆ»åº¦
        ctx.beginPath(); ctx.strokeStyle='#30363d'; ctx.lineWidth=2; ctx.moveTo(0,ly); ctx.lineTo(canvas.width,ly); ctx.stroke();
        ctx.fillStyle='#8b949e'; ctx.font='12px Consolas';
        [-2*f, -f, f, 2*f].forEach((p,i)=>{ 
            const px=lx+p; ctx.beginPath(); ctx.arc(px,ly,3,0,Math.PI*2); ctx.fill(); 
            ctx.fillText(['2F','F','F','2F'][i], px-5, ly+20); 
        });

        // é€é•œ
        ctx.shadowBlur=15; ctx.shadowColor='rgba(88,166,255,0.6)'; ctx.strokeStyle='#58a6ff'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.ellipse(lx,ly,8,canvas.height*0.35,0,0,Math.PI*2); ctx.stroke(); ctx.shadowBlur=0;

        // è®¡ç®—åƒ
        const u_px = objectPos.x_cm * SCALE;
        let v_px=0, imgH=0, isVirt=false;
        if (Math.abs(u_px-f)<0.5) v_px=Infinity;
        else {
            v_px = (f*u_px)/(u_px-f);
            const M = v_px/u_px; imgH=h*M;
            if(u_px<f) isVirt=true;
        }

        // ç»˜åˆ¶ç‰©ä½“
        drawArrow(lx-u_px, ly, h, '#3fb950', 'ç‰©ä½“');
        
        // ç»˜åˆ¶åƒ
        if(v_px!==Infinity) {
            const col = isVirt?'#d2a8ff':'#f2cc60';
            ctx.save(); if(isVirt)ctx.setLineDash([5,5]);
            drawArrow(lx+v_px, ly, -imgH, col, isVirt?'è™šåƒ':'å®åƒ');
            ctx.restore();
        }

        // ç»˜åˆ¶å…‰çº¿
        ctx.lineWidth=1; ctx.strokeStyle='rgba(88,166,255,0.4)';
        // 1. å¹³è¡Œ -> ç„¦ç‚¹
        ctx.beginPath(); ctx.moveTo(lx-u_px, ly-h); ctx.lineTo(lx, ly-h); ctx.lineTo(lx+f*10, ly+(h)*10); ctx.stroke();
        // 2. è¿‡å…‰å¿ƒ
        ctx.beginPath(); ctx.moveTo(lx-u_px, ly-h); 
        const slope = (ly-(ly-h))/(lx-(lx-u_px));
        ctx.lineTo(lx+1000, ly+1000*slope); ctx.stroke();
        // è™šåƒè¾…åŠ©çº¿
        if(isVirt) {
             ctx.save(); ctx.setLineDash([4,6]); ctx.strokeStyle='rgba(210,168,255,0.3)';
             ctx.beginPath(); ctx.moveTo(lx, ly-h); ctx.lineTo(lx+v_px, ly+imgH); 
             ctx.moveTo(lx, ly); ctx.lineTo(lx+v_px, ly+imgH); ctx.stroke(); ctx.restore();
        }

        // æ›´æ–°æ–‡å­—
        const pCn = document.getElementById('img-prop-cn');
        if(v_px===Infinity) { pCn.innerText="ä¸æˆåƒ"; pCn.style.color="#8b949e"; }
        else {
            if(isVirt) { pCn.innerText="æ­£ç«‹Â·æ”¾å¤§Â·è™šåƒ"; pCn.style.color="#d2a8ff"; }
            else {
                let s = (Math.abs(Math.abs(v_px)-u_px)<1)?"ç­‰å¤§":(Math.abs(v_px)>u_px)?"æ”¾å¤§":"ç¼©å°";
                pCn.innerText=`å€’ç«‹Â·${s}Â·å®åƒ`; pCn.style.color="#f2cc60";
            }
        }
    }

    function drawArrow(x, y, h, col, txt) {
        ctx.shadowBlur=10; ctx.shadowColor=col; ctx.strokeStyle=col; ctx.fillStyle=col; ctx.lineWidth=4; ctx.lineCap='round';
        ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x,y-h); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x,y-h); ctx.lineTo(x-6,y-h+(h>0?10:-10)); ctx.lineTo(x+6,y-h+(h>0?10:-10)); ctx.fill(); ctx.shadowBlur=0;
        ctx.font='bold 14px Consolas'; ctx.textAlign='center'; ctx.fillText(txt, x, y-h-(h>0?15:-25)); ctx.textAlign='start';
    }

    setTimeout(()=>{resizeCanvas(); updateAllUI();}, 100);
</script>
</body>
</html>
