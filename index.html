<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI å…‰è·¯å®éªŒå®¤ v3.0 (è§†è§‰ç‰ˆ)</title>
    <style>
        body { margin: 0; background: #0d1117; color: #c9d1d9; font-family: 'PingFang SC', monospace; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding-top: 10px; box-sizing: border-box; touch-action: pan-y; }
        
        /* é¡¶éƒ¨ AI æ  */
        #ai-bar { width: 95vw; max-width: 800px; display: flex; gap: 8px; margin-bottom: 10px; z-index: 100; align-items: center; }
        #ai-input { flex: 1; background: rgba(22, 27, 34, 0.9); border: 1px solid #30363d; color: #fff; padding: 10px; border-radius: 8px; outline: none; }
        
        /* ğŸ“· ç›¸æœºæŒ‰é’®æ ·å¼ */
        .btn-icon {
            background: #30363d; color: #fff; border: 1px solid #8b949e; 
            padding: 0 15px; height: 40px; border-radius: 8px; cursor: pointer; 
            font-size: 20px; display: flex; align-items: center; justify-content: center;
        }
        #btn-analyze { background: #238636; color: #fff; border: none; padding: 0 20px; height: 40px; border-radius: 8px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .loading { opacity: 0.7; cursor: wait; }
        #file-input { display: none; } /* éšè—æ–‡ä»¶é€‰æ‹©æ¡† */

        /* HUD & Controls */
        #hud-container { display: flex; width: 95vw; gap: 5px; margin-bottom: 10px; justify-content: center; flex-wrap: wrap; }
        .hud-box { background: rgba(22, 27, 34, 0.85); border: 1px solid #30363d; border-radius: 8px; padding: 5px 10px; text-align: center; flex: 1; min-width: 65px; }
        .hud-value { font-size: 18px; font-weight: bold; color: #58a6ff; font-family: monospace; }
        .hud-label { font-size: 10px; color: #8b949e; display: block; margin-bottom: 2px; }
        
        #control-panel { width: 95vw; background: rgba(22,27,34,0.9); border: 1px solid #30363d; border-radius: 8px; padding: 10px; margin-bottom: 10px; box-sizing: border-box; }
        .control-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; }
        .input-smart { width: 40px; background: #0d1117; border: 1px solid #30363d; color: #58a6ff; text-align: right; border-radius: 4px; }
        input[type=range] { width: 100%; }
        
        #canvas-wrapper { position: relative; width: 95vw; max-width: 800px; aspect-ratio: 2/1; border: 1px solid #30363d; border-radius: 12px; overflow: hidden; background: #0d1117; touch-action: none; background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px); background-size: 20px 20px; }
        canvas { display: block; width: 100%; height: 100%; }
        #formula-bar { margin-top: 10px; padding: 5px; border-radius: 8px; background: #161b22; border: 1px solid #30363d; font-size: 12px; width: 95vw; text-align: center; color: #8b949e; font-family: monospace; }
        .formula-highlight { color: #58a6ff; font-weight: bold; } .formula-result { color: #f2cc60; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ai-bar">
        <button id="btn-upload" class="btn-icon" onclick="document.getElementById('file-input').click()">ğŸ“·</button>
        <input type="file" id="file-input" accept="image/*">
        
        <input type="text" id="ai-input" placeholder="è¾“å…¥æè¿°ï¼Œæˆ–ç›´æ¥æ‹ç…§ä¸Šä¼  ->">
        <button id="btn-analyze" onclick="callAI()">AI è¯†åˆ«</button>
    </div>

    <div id="hud-container">
        <div class="hud-box"><span class="hud-label">ç„¦è· F</span><span id="hud-f" class="hud-value">10.0</span></div>
        <div class="hud-box"><span class="hud-label">ç‰©è· U</span><span id="val-u" class="hud-value" style="color:#58a6ff">20.0</span></div>
        <div class="hud-box"><span class="hud-label">åƒè· V</span><span id="val-v" class="hud-value" style="color:#f2cc60">20.0</span></div>
        <div class="hud-box" style="flex:1.5"><span class="hud-label">æ€§è´¨</span><span id="img-prop-cn" class="hud-value" style="font-size:14px">å°±ç»ª</span></div>
    </div>

    <div id="control-panel">
        <div style="margin-bottom:5px"><div class="control-header"><span>ç„¦è· f</span><input type="text" id="input-f" class="input-smart" value="10.0"></div><input type="range" id="slider-f" min="5" max="25" step="0.1" value="10"></div>
        <div><div class="control-header"><span>ç‰©è· u</span><input type="text" id="input-u" class="input-smart" value="20.0"></div><input type="range" id="slider-u" min="2" max="60" step="0.1" value="20"></div>
    </div>

    <div id="canvas-wrapper"><canvas id="opticsCanvas"></canvas></div>
    <div id="formula-bar">1/f = 1/u + 1/v &nbsp;|&nbsp; <span id="formula-dynamic">...</span></div>

<script>
    let currentImageBase64 = null;

    // ç›‘å¬æ–‡ä»¶é€‰æ‹©
    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // æŒ‰é’®å˜è‰²æç¤ºå·²é€‰æ‹©
        document.getElementById('btn-upload').style.background = "#238636";
        document.getElementById('btn-upload').innerText = "âœ…";
        
        // è¯»å–å›¾ç‰‡è½¬ Base64
        const reader = new FileReader();
        reader.onload = function(evt) {
            currentImageBase64 = evt.target.result;
            // è‡ªåŠ¨è§¦å‘è¯†åˆ«
            callAI(); 
        };
        reader.readAsDataURL(file);
    });

    async function callAI() {
        const input = document.getElementById('ai-input');
        const btn = document.getElementById('btn-analyze');
        const text = input.value;

        if (!text && !currentImageBase64) return alert("è¯·å…ˆè¾“å…¥æ–‡å­—æˆ–ä¸Šä¼ å›¾ç‰‡");

        btn.innerText = "ğŸ‘€ è¯†åˆ«ä¸­...";
        btn.classList.add('loading');

        try {
            const response = await fetch('https://57f7d6f0.r38.cpolar.top/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    text: text,
                    image: currentImageBase64
                })
            });
            
            const data = await response.json();
            console.log("AI Data:", data);

            if(data.f) { f_cm = data.f; f = f_cm * SCALE; sliderF.value = f_cm; inputF.value = f_cm; }
            if(data.u) { objectPos.x_cm = data.u; sliderU.value = data.u; inputU.value = data.u; }
            
            updateAllUI(); draw();
            
            if(currentImageBase64) {
                document.getElementById('btn-upload').style.background = "#30363d";
                document.getElementById('btn-upload').innerText = "ğŸ“·";
                currentImageBase64 = null; 
                document.getElementById('file-input').value = ''; 
            }

        } catch (error) {
            console.error(error);
            alert("è¯†åˆ«å¤±è´¥ï¼è¯·ç¡®ä¿ Python åå°æ­£åœ¨è¿è¡Œ");
        } finally {
            btn.innerText = "AI è¯†åˆ«";
            btn.classList.remove('loading');
        }
    }

    // --- ç‰©ç†å¼•æ“ (ä¿æŒä¸å˜) ---
    const canvas = document.getElementById('opticsCanvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() { const c=document.getElementById('canvas-wrapper'); canvas.width=c.clientWidth; canvas.height=c.clientHeight; draw(); }
    window.addEventListener('resize', resizeCanvas);
    const SCALE = 10; let f_cm = 10.0; let f = f_cm * SCALE; let objectPos = { x_cm: 20.0, h: 60 }; let isDragging = false;
    function getPointerCm(e) { const rect = canvas.getBoundingClientRect(); const clientX = (e.touches && e.touches.length) ? e.touches[0].clientX : e.clientX; const x_px = (clientX - rect.left) * (canvas.width / rect.width); return (canvas.width/2 - x_px) / SCALE; }
    function handleStart(e) { if(Math.abs(getPointerCm(e) - objectPos.x_cm) < 4.0) { isDragging = true; canvas.style.cursor = 'grabbing'; } }
    function handleMove(e) { if(isDragging) { if(e.cancelable) e.preventDefault(); let u = getPointerCm(e); if(u<1) u=1; if(u>((canvas.width/2)/SCALE-1)) u=((canvas.width/2)/SCALE-1); objectPos.x_cm = u; syncUI(); draw(); } }
    function handleEnd() { isDragging = false; canvas.style.cursor = 'crosshair'; }
    canvas.addEventListener('mousedown', handleStart); canvas.addEventListener('mousemove', handleMove); canvas.addEventListener('mouseup', handleEnd);
    canvas.addEventListener('touchstart', handleStart, {passive:false}); canvas.addEventListener('touchmove', handleMove, {passive:false}); canvas.addEventListener('touchend', handleEnd);
    const sliderF=document.getElementById('slider-f'), inputF=document.getElementById('input-f'); const sliderU=document.getElementById('slider-u'), inputU=document.getElementById('input-u');
    function syncUI() { sliderU.value = objectPos.x_cm.toFixed(1); inputU.value = objectPos.x_cm.toFixed(1); updateAllUI(); }
    sliderF.oninput = function() { f_cm=parseFloat(this.value); f=f_cm*SCALE; inputF.value=this.value; updateAllUI(); draw(); }
    sliderU.oninput = function() { objectPos.x_cm=parseFloat(this.value); inputU.value=this.value; updateAllUI(); draw(); }
    function updateAllUI() { document.getElementById('hud-f').innerText = f_cm.toFixed(1); document.getElementById('val-u').innerText = objectPos.x_cm.toFixed(1); let v="âˆ"; const u=objectPos.x_cm; if(Math.abs(u-f_cm)>0.1) v = Math.abs((f_cm*u)/(u-f_cm)).toFixed(1); document.getElementById('val-v').innerText = v; let s = v==="âˆ" ? "ä¸æˆåƒ" : (u<f_cm ? "æ­£ç«‹æ”¾å¤§è™šåƒ" : `å€’ç«‹${Math.abs(v)>u ? 'æ”¾å¤§':'ç¼©å°'}å®åƒ`); document.getElementById('img-prop-cn').innerText = s; document.getElementById('formula-dynamic').innerHTML = `1/${f_cm.toFixed(1)} = 1/${u.toFixed(1)} + 1/${v}`; }
    function draw() { ctx.clearRect(0,0,canvas.width,canvas.height); const lx=canvas.width/2, ly=canvas.height/2; const h = objectPos.h * (canvas.height/400); ctx.beginPath(); ctx.strokeStyle='#30363d'; ctx.moveTo(0,ly); ctx.lineTo(canvas.width,ly); ctx.stroke(); ctx.fillStyle='#8b949e'; ctx.font='12px monospace'; [-2*f, -f, f, 2*f].forEach((p,i)=>{ ctx.beginPath(); ctx.arc(lx+p,ly,3,0,6.28); ctx.fill(); ctx.fillText(['2F','F','F','2F'][i], lx+p-5, ly+20); }); ctx.shadowBlur=15; ctx.shadowColor='#58a6ff'; ctx.strokeStyle='#58a6ff'; ctx.lineWidth=3; ctx.beginPath(); ctx.ellipse(lx,ly,8,canvas.height*0.35,0,0,6.28); ctx.stroke(); ctx.shadowBlur=0; const u_px=objectPos.x_cm*SCALE; let v_px=0, imgH=0, isVirt=false; if(Math.abs(u_px-f)<0.5) v_px=Infinity; else { v_px=(f*u_px)/(u_px-f); imgH=h*(v_px/u_px); if(u_px<f) isVirt=true; } drawArrow(lx-u_px, ly, h, '#3fb950'); if(v_px!==Infinity) { ctx.save(); if(isVirt)ctx.setLineDash([5,5]); drawArrow(lx+v_px, ly, -imgH, isVirt?'#d2a8ff':'#f2cc60'); ctx.restore(); } ctx.lineWidth=1; ctx.strokeStyle='rgba(88,166,255,0.4)'; ctx.beginPath(); ctx.moveTo(lx-u_px,ly-h); ctx.lineTo(lx,ly-h); ctx.lineTo(lx+f*10,ly+h*10); ctx.stroke(); ctx.beginPath(); ctx.moveTo(lx-u_px,ly-h); ctx.lineTo(lx+1000,ly+1000*(h/u_px)); ctx.stroke(); if(isVirt) { ctx.save(); ctx.setLineDash([4,6]); ctx.strokeStyle='rgba(210,168,255,0.3)'; ctx.beginPath(); ctx.moveTo(lx, ly-h); ctx.lineTo(lx+v_px, ly+imgH); ctx.moveTo(lx, ly); ctx.lineTo(lx+v_px, ly+imgH); ctx.stroke(); ctx.restore(); } }
    function drawArrow(x,y,h,c){ ctx.strokeStyle=c; ctx.fillStyle=c; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x,y-h); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y-h); ctx.lineTo(x-5,y-h+(h>0?10:-10)); ctx.lineTo(x+5,y-h+(h>0?10:-10)); ctx.fill(); }
    setTimeout(()=>{resizeCanvas(); updateAllUI();}, 100);
</script>
</body>
</html>
